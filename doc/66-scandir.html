<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="Content-Language" content="en" />
    <title>66: the 66-scandir program</title>
    <meta name="Description" content="66: the 66-scandir program" />
    <meta name="Keywords" content="66 command 66-scandir scandir supervision supervise svscan creation live" />
    <!-- <link rel="stylesheet" type="text/css" href="//skarnet.org/default.css" /> -->
  </head>
<body>

<p>
<a href="index.html">66</a><br />
<a href="//obarun.org/">www.obarun.org</a>
</p>

<h1> The 66-scandir program </h1>

<p>
66-scandir handle a scandir for a specific given user. It is designed
to be either the root or a branch of a <em>supervision tree</em>.
</p>

<h2> Interface </h2>
<pre>
     66-scandir [ -h help ] [ -v <em>verbosity</em> ] [ -b boot ] [ -l <em>live</em> ] [ -t <em>rescan</em> ] [ -2 <em>stage2.tini</em> ] [ -3 <em>stage3</em> ] [ -e <em>environment</em> ] [ -c create ] [ -r remove ] [ -u up ] [ -s <em>signal</em> ] owner
</pre>

<p>66-scandir will handle or create the scandir at <em>live</em> for a specific 
<em>owner</em> depending of the options given. The <em>owner</em> can 
be any valid user on the system. However, the <em>owner</em> must have sufficient
permissions to create the necessary directories at <em>live</em>. If the
<em>owner</em> is not set, the user of the current process will be took.</p>

<h2> Options </h2>

<ul>
 <li> <tt>-h&nbsp;</tt>&nbsp;: print the help. </li>
 
 <li> <tt>-v&nbsp;<em>verbosity</em></tt>&nbsp;: increase/decrease verbosity level.
 0 or 1: print only error messages. 2: print warning message. Over 3: debugging mode. </li>
 
 <li> <tt>-b&nbsp;</tt>&nbsp;: create specific files for boot. Only root
 user can use this option - see below.</li>
 
 <li> <tt>-l&nbsp;<em>live</em></tt>&nbsp;: create the scandir at <em>live</em>.Default is
 <tt>/run/66</tt>. The default can be changed at compile-time by
 giving the <tt>--livedir=<em>live</em></tt> option to <tt>./configure</tt>.</li>
 
 <li> <tt>-t&nbsp;<em>rescan</em></tt>&nbsp;: perform a scan every <em>rescan</em>
 milliseconds. If <em>rescan</em> is 0 (the default), automatic scans are never performed after
 the first one and s6-svscan will only detect new services when told to 
 via a <em>66-scandir -d reload</em> command or
 <a href="https://skarnet.org/software/s6/s6-svscanctl.html">66-svscanctl -a</a> command.
 It is <em>strongly</em> discouraged to set
 <em>rescan</em> to a positive value under 500. </li>
 
 <li> <tt>-2&nbsp;<em>stage2.tini</em></tt>&nbsp;: set the command to 
 execute with configurable handlers when the scandir receive a signal.
 An absolute path is expected. This options is mandatory if the <em>-b</em>
 has been given. If it's not specified /etc/66/stage2.tini scripts is
 took by default. Without the <em>-b</em> options, this options have 
 no effects - see below.</li>
 
 <li> <tt>-3&nbsp;<em>stage3</em></tt>&nbsp;: set the command script to 
 execute when the scandir is asked to be shutted down. An absolute path is expected. 
 This options is mandatory if the <em>-b</em> has been given. If it's not specified 
 /etc/66/stage3 scripts is took by default. Without the <em>-b</em> options, this
 options have no effects - see below.</li>
 
 <li> <tt>-e&nbsp;<em>environment</em></tt>&nbsp;: adjust the environment variable of the scandir with 
 variables find on the <em>environment</em> directory. It reads every files
 in <em>environment</em> directory that does not begin with a dot and does
 not contain the '=' character. An absolute path is expected. </li>
 
 <li> <tt>-c&nbsp;</tt>&nbsp;: create the neccessary directories at <em>live</em>.
 This option is expected to be done before trying to run the scandir by the options <em>-u</em>.</li>
 
 <li> <tt>-r&nbsp;</tt>&nbsp;: remove the scandir directory at <em>live</em>. 
 The scandir must be stopped previously with the options <em>-d</em>.</li>
 <li> <tt>-u&nbsp;</tt>&nbsp;: start the scandir directory at <em>live</em>. </li>
 
 <li> <tt>-s&nbsp;<em>signal</em></tt>&nbsp;: send a <em>signal</em> to the scandir directory.
 The signal can be any valid <a href="https://skarnet.org/software/s6/s6-svscanctl.html">s6-svscanctl</a>
 command more some convenient sentence - see below. </li>
</ul>

<h2> Signals </h2>

<p>The options <em>-s</em> to send a signal to the scandir is builded 
around the <a href="https://skarnet.org/software/s6/s6-svscanctl.html">s6-svscanctl</a> 
program and act with exactly the same behaviour. Any signal accepted by 
<em>s6-svscanctl</em> program can be passed but need to be done without the '-' 
character at the begin of the signal. If, for example, you want to send a <em>-t</em>
signal you need to use: <em>66-scandir -s t</em>. Series of command is also accepted
in the same manner: <em>66-scandir -s st</em>.<br>
Also some convenient sentence was added to avoid to remember basic and usefull series
of command like :
<ul>
 <li><tt>reload&nbsp;</tt>&nbsp;: this will send an <em>-an</em> command</li>
 <li><tt>interrupt&nbsp;</tt>&nbsp;: this will send an <em>-i</em> command</li>
 <li><tt>quit&nbsp;</tt>&nbsp;: this will send an <em>-q</em> command</li>
 <li><tt>halt&nbsp;</tt>&nbsp;: this will send an <em>-0</em> command</li>
 <li><tt>reboot&nbsp;</tt>&nbsp;: this will send an <em>-6</em> command</li>
 <li><tt>poweroff&nbsp;</tt>&nbsp;: this will send an <em>-7</em> command</li>
</ul></p>

<h3>Signal usage examples</h3>
<pre> 66-scandir -s reload </pre>
<p>
 Updates the process supervision tree
to exactly match the services listed in <tt>scandir</tt>.
</p>
<p>This command is strictly equal to :</p>
<pre>s6-svscanctl -an /service</pre>

<h2>Scandir creation process</h2>

<p>When you ask for a creation of the <em>scandir</em> various files 
and directories will be created at <tt>live</tt> directory for the given <tt>owner</tt>. 
If you run the <em>66-scandir</em> with the user root, you will find 
in <tt>/run/66</tt> (default directory is took for the example) :
<ul>
 <li><tt>/run/66/scandir/0&nbsp;</tt>&nbsp;: where <tt>0</tt> is the 
 corresponding uid for the root user. This directory store all longrun
 proccess (a.k.a. daemon) started by the user root.</li>
 <li><tt>/run/66/tree/0&nbsp;</tt>&nbsp;: This directory store all s6-rc
 service database started by the user root.</li>
 <li><tt>/run/66/log/0&nbsp;</tt>&nbsp;: This directory store the catch-all
 logger when the scandir is created for a boot procedure.</li>
</ul>
</p>
<p>If you ask for the creation of the scandir with normal user you will
find <tt>/run/66/scandir/1000</tt> where <tt>1000</tt> is the corresponding uid
for the user, and <tt>/run/66/tree/1000</tt>. The log directory is not set due
of the missing permissions to create the scandir for the boot process, instead 
it will be found by default at <tt>/var/log/scandir-1000</tt>. Default log
directory can be changed at compile-time by giving the <tt>--with-system-logpath=<em>DIR</em></tt>
option for root permissions and <tt>--with-user-logpath=<em>DIR</em></tt> options
for user permissions to <tt>./configure</tt>.</li></p>

<p>An existing <em>scandir</em> directory will be used as it and the creation will be skipped.
If you want to create a fresh <em>scandir</em> directory for the same <tt>owner</tt>, use the
<tt>-r</tt> options before.</p>

<h3>.s6-svscan control directory</h3>

<p><a href="https://skarnet.org/software/s6/s6-svscan.html">s6-svscan</a>
program expect to find some control file when it receive a signal. Thoses
files are not mandatory and are not created by any <em>s6</em> program
but are usefull to control the e.g shutdown process. The <em>66-scandir</em>
program will care of it and create those files at <tt>/run/66/scandir/0/.s6-svscan</tt>
directory. Depending if the <tt>-b</tt> options is passed or not to the command line,
the files will change.</p>
<p>The path of the scandir in those files is automatically define in 
conjonction with the <tt>-l <em>live</em></tt> options.</p>

<h5>crash file</h5>
<p>With or without the <tt>-b</tt> options the file will be:</p>
<pre>#!/usr/bin/execlineb -P
redirfd -r 0 /dev/console
redirfd -w 1 /dev/console
fdmove -c 2 1
s6-echo -- "scandir /run/66/scandir/0 crashed ... "
/bin/sh -i
</pre>

<h5>finish file</h5>
<p>With the <tt>-b</tt> options the file will be:</p>
<pre>#!/usr/bin/execlineb -S0
/etc/66/stage3 $@</pre>
<p>The last command is set by the <tt>-3&nbsp;<em>stage3</em></tt> options given 
on the command line. If your e.g <tt>stage3</tt> argument is <em>/usr/bin/true</em>
your <em>finish</em> file will be: 
<pre>#!/usr/local/bin/execlineb -S0
/usr/bin/true</pre></p>
<p>without the <tt>-b</tt> option</p>
<pre>#!/usr/bin/execlineb -S0
s6-echo -- "scandir /run/66/scandir/1000 shutted down..."</pre>

<h5>SIGHUP file</h5>
<p>With the <tt>-b</tt> options the file will be:</p>
<pre>#!/usr/bin/execlineb -P
foreground { /etc/66/stage2.tini }
s6-svscanctl -h -- /run/66/scandir/0</pre>
<p>The command executed before sending a signal to the scandir is set
by the <tt>-2&nbsp;<em>stage2.tini</em></tt> options given 
on the command line.</p>

<p>Without the <tt>-b</tt> options the file will be:</p>
<pre>#!/usr/bin/execlineb -P
foreground { 66-all -v3 -l /run/66/ down }
s6-svscanctl -h -- /run/66/scandir/0</pre>

<h5>SIGINT file</h5>
<p>With the <tt>-b</tt> options the file will be:</p>
<pre>#!/usr/bin/execlineb -P
foreground { /etc/66/stage2.tini }
s6-svscanctl -6 -- /run/66/scandir/0
</pre>
<p>Without the <tt>-b</tt> options the file will be:</p>
<pre>#!/usr/bin/execlineb -P
foreground { 66-all -v3 -l /run/66/ down }
s6-svscanctl -6 -- /run/66/scandir/0</pre>

<h5>SIGQUIT file</h5>
<p>With the <tt>-b</tt> options the file will be:</p>
<pre>#!/usr/bin/execlineb -P
foreground { /etc/66/stage2.tini }
s6-svscanctl -q -- /run/66/scandir/0</pre>

<p>Without the <tt>-b</tt> options the file will be:</p>
<pre>#!/usr/bin/execlineb -P
foreground { 66-all -v3 -l /run/66/ down }
s6-svscanctl -q -- /run/66/scandir/0</pre>

<h5>SIGTERM file</h5>
<p>With the <tt>-b</tt> options the file will be:</p>
<pre>#!/usr/bin/execlineb -P
foreground { /etc/66/stage2.tini }
s6-svscanctl -t -- /run/66/scandir/0</pre>

<p>Without the <tt>-b</tt> options the file will be:</p>
<pre>#!/usr/bin/execlineb -P
foreground { 66-all -v3 -l /run/66/ down }
s6-svscanctl -t -- /run/66/scandir/0</pre>

<h5>SIGUSR1 file</h5>
<p>With the <tt>-b</tt> options the file will be:</p>
<pre>#!/usr/bin/execlineb -P
foreground { /etc/66/stage2.tini }
s6-svscanctl -7 -- /run/66/scandir/0</pre>

<p>Without the <tt>-b</tt> options the file will be:</p>
<pre>#!/usr/bin/execlineb -P
foreground { 66-all -v3 -l /run/66/ down }
s6-svscanctl -7 -- /run/66/scandir/0</pre>

<h5>SIGUSR2 file</h5>
<p>With the <tt>-b</tt> options the file will be:</p>
<pre>#!/usr/bin/execlineb -P
foreground { /etc/66/stage2.tini }
s6-svscanctl -O -- /run/66/scandir/0</pre>

<p>Without the <tt>-b</tt> options the file will be:</p>
<pre>#!/usr/bin/execlineb -P
foreground { 66-all -v3 -l /run/66/ down }
s6-svscanctl -O -- /run/66/scandir/0</pre>

<h2>Environment configuration</h2>

You can modify the environment variable at the start of the scandir with the 
<tt>-e</tt> options. This option expect to find a valid absolute path 
for a directory which contain files where the format of the file is :
<ul>
<li> The name of the files is the name of the key. The name do not begin
by a dot and do not contain '=' character.</li>
<li> The contain of the file is the value of the key. Only one value is
accepted followed by an empty new line.</li>
</ul>
<h3>Environment file example</h3>
<p>name of the file: <tt>/etc/66/env/TZ</tt></p>
<p>contain of the file:
<pre>Pacific/Noumea</pre></p>
<p>Every daemon launched on the scandir should inherit of the environment
variable of the scandir. So if you want to have a specific <em>key=value</em>
pair for every daemon, use this option.</p>

<h2>Scandir remove process</h2>

<p>When you use the <tt>-r</tt> options some directories of the scandir will
be removed but not all the componments of the directory. In our previous
example: </p>
<ul>
<li><tt>/run/66/scandir/0 will be removed</tt></li>
<li><tt>/run/66/tree/0 will be removed</tt></li>
<li><tt>/run/66/log/0 will be removed</tt></li>
</ul>
<p>The root <tt>live</tt> (a.k.a <tt>/run/66</tt>) directory will be not
removed because an another user can still use it. In fact the <em>66-scandir</em>
will only remove the componment of the corresponding uid of the <tt>owner</tt>.</p>
<p>A running scandir can not be removed. You must stop first the scandir to 
be able to remove it.</p>
</body>
</html>
