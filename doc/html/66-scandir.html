<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="date" content="2020-05-08" scheme="YYYY-MM-DD" />
<meta name="author" content="Eric Vidal &lt;eric@obarun.org&gt;" />
<title>The 66 Suite: 66-scandir</title>
</head>
<body>

<p><a href="index.html">66</a></p>

<p><a href="https://web.obarun.org">obarun.org</a></p>

<h1 id="66-scandir">66-scandir</h1>

<p>Handles the <em>scandir</em> for a given user. Designed to be either root or a branch of the supervision tree.</p>

<h2 id="Interface">Interface</h2>

<pre><code>    66-scandir [ -h ] [ -z ] [ -v verbosity ] [ -b ] [ -l live ] [ -d notif ][ -t rescan ] [ -L log_user ] [ -s skel ] [ -e environment ] [ -c | r | u ] owner
</code></pre>

<p>This program creates or starts the <em>scandir</em> (directory containing a collection of s6‑supervise processes) for the given <em>owner</em> depending on the provided options. Note that <em>owner</em> can be any valid user on the system. However, the given user must have sufficient permissions to create the necessary directories at its location. That is <code>%%livedir%%</code> by default or the resulting path provided by the <strong>‑l</strong> option. If <em>owner</em> is not explicitely set then the user of the current process will be used instead. </p>

<h2 id="Exit%20codes">Exit codes</h2>

<ul>
<li><em>0</em> success</li>
<li><em>100</em> wrong usage</li>
<li><em>111</em> system call failed</li>
</ul>

<h2 id="Options">Options</h2>

<ul>
<li><p><strong>-h</strong> : prints this help.</p></li>
<li><p><strong>-z</strong> : use color.</p></li>
<li><p><strong>-v</strong> <em>verbosity</em> : increases/decreases the verbosity of the command.</p>

<ul>
<li><em>1</em> : only print error messages. This is the default.</li>
<li><em>2</em> : also print warning messages.</li>
<li><em>3</em> : also print tracing messages.</li>
<li><em>4</em> : also print debugging messages.</li>
</ul></li>
<li><p><strong>-b</strong> : create specific files for boot. Only the root user can use this option. It is not meant to be used directly even with root. <a href="66%E2%80%91boot.html">66-boot</a> calls it during the boot process.</p></li>
<li><p><strong>-l</strong> <em>live</em> : changes the supervision directory of <em>service</em> to <em>live</em>. By default this will be <code>%%livedir%%</code>. The default can also be changed at compile time by passing the <code>--livedir=live</code> option to <code>./configure</code>. An existing absolute path is expected and should be within a writable filesystem - likely a RAM filesystem—see <a href="66-scandir.html">66-scandir</a>.</p></li>
<li><p><strong>-d</strong> <em>notif</em> : notify readiness on file descriptor notif. When <em>scandir</em> is ready to accept commands from <a href="66-scanctl.html">66‑scanctl</a>, it will write a newline to <em>notif</em>. <em>notif</em> <strong>cannot be</strong> lesser than <code>3</code>. By default, no notification is sent. If <strong>-b</strong> is set, this option have no effects.</p></li>
<li><p><strong>-t</strong> <em>rescan</em> : perform a scan every <em>rescan</em> milliseconds. If <em>rescan</em> is set to 0 (the default), automatic scans are never performed after the first one and <a href="https://skarnet.org/software/s6/s6-svscan.html">s6‑svscan</a> will only detect new services by issuing either <a href="66-scanctl.html">66‑scanctl</a> reload or <a href="https://skarnet.org/software/s6/s6-svscanctl.html">s6‑svscanctl -a</a>. It is <strong>strongly</strong> discouraged to set rescan to a positive value under <code>500</code>.</p></li>
<li><p><strong>-s</strong> <em>skel</em> : an absolute path. Directory containing <em>skeleton</em> files. This option is not meant to be used directly even with root. <a href="66-boot.html">66‑boot</a> calls it during the boot process. Default is <code>%%skel%%</code>.</p></li>
<li><p><strong>-L</strong> <em>log_user</em> : will run the <code>catch-all</code> logger as <em>log_user</em>. Default is <code>%%s6log_user%%</code>. The default can also be changed at compile-time by passing the <code>‑‑with‑s6‑log‑user=user</code> option to <code>./configure</code>.</p></li>
<li><p><strong>-e</strong> <em>environment</em> : an absolute path. Merge the current environment variables of <em>scandir</em> with variables found in this directory. Any file in environment not beginning with a dot and not containing the <code>=</code> character will be read and parsed.</p></li>
<li><p><strong>-c</strong> : create the neccessary directories at <em>live</em>. <strong><em>Must be</em></strong> executed once with this option before being able to use <strong>‑u</strong>.</p></li>
<li><p><strong>-r</strong> : remove the <em>scandir</em> directory at <em>live</em>. If it was already started with <strong>‑u</strong> it <strong><em>must</em></strong> first be stopped sending a signal with <a href="66-scanctl.html">66‑scanctl quit</a> or similar.</p></li>
<li><p><strong>-u</strong> : start the <em>scandir</em> directory at <em>live</em> calling <a href="https://skarnet.org/software/s6/s6-svscan.html">s6‑svscan</a>.</p></li>
</ul>

<h2 id="Scandir%20creation%20process">Scandir creation process</h2>

<p>When creating the <em>scandir</em> with the <strong>‑c</strong> option various files and directories will be created at the <em>live</em> directory for the given <em>owner</em>.</p>

<p>If created with the user root, you will find the following in <code>%%livedir%%</code> (the directory created by default if <strong>‑l</strong> is not passed and 0 being the corresponding UID for the root user):</p>

<ul>
<li><p><em>%%livedir%%/scandir/0</em> : stores all longrun proccesses (commonly known as daemons) started by root.</p></li>
<li><p><em>%%livedir%%/tree/0</em> : stores any <a href="https://skarnet.org/software/s6-rc">s6‑rc</a> service database started by root.</p></li>
<li><p><em>%%livedir%%/log/0</em> : stores the <code>catch-all</code> logger when the <em>scandir</em> is created for a boot procedure with the <strong>‑b</strong> option.</p></li>
<li><p><em>%%livedir%%/state/0</em> : stores internal <em>66</em> ecosystem files.</p></li>
</ul>

<p>If the <em>scandir</em> was created with a regular user you will find the following in <code>%%livedir%%</code>
(Default directories if <strong>‑l</strong> is not passed and 1000 being the UID for the user):</p>

<ul>
<li><p><em>%%livedir%%/scandir/1000</em></p></li>
<li><p><em>%%livedir%%/tree/1000</em></p></li>
<li><p><em>%%livedir%%/state/1000</em></p></li>
</ul>

<p>If a <em>scandir</em> already existed at the default location for the given user it will prevent its creation when calling <code>66‑scandir ‑c</code>. If you wanted to create a different scandir for the same owner at the same live location you must delete it first with <strong>‑r</strong>.</p>

<h2 id="Environment%20configuration">Environment configuration</h2>

<p>You can modify environment variables when starting the <em>scandir</em> with the <strong>‑e</strong> option. This option expects to find a valid absolute path to a directory containing one or more files where the format is the classic <code>key=value</code> pair. Each file found will be read and parsed.</p>

<p>Any service launched on the <em>scandir</em> will inherit the environment variables of the scandir. A specific global <code>key=value</code> pair inherited by all service can be set using this option.</p>

<h3 id="Limits">Limits</h3>

<p>The mentioned environment directory <strong><em>can not</em></strong> exceed more than <code>100</code> files. Each file can not contain more than <code>4095</code> bytes or more than <code>50</code> <code>key=value</code> pairs.</p>

<h2 id="Scandir%20removal%20process">Scandir removal process</h2>

<p>When using the <strong>‑r</strong> option to delete the <em>scandir</em> of a given user some directories of the <em>scandir</em> may not be removed if another user accesses them. In our previous example where we created a <em>scandir</em> for root with UID <code>0</code> and a regular user with the UID <code>1000</code> this would imply the following:</p>

<ul>
<li><p><em>%%livedir%%/scandir/0</em> # will be deleted</p></li>
<li><p><em>%%livedir%%/tree/0</em>    # will be deleted</p></li>
<li><p><em>%%livedir%%/log/0</em>     # will be deleted</p></li>
<li><p><em>%%livedir%%/state/0</em>   # will be deleted</p></li>
</ul>

<p>The <em>live</em> directory of the root user (in this example and by default <code>%%livedir%%</code>) will not be removed because another user (the one from our example) can still use it. In fact <em>66‑scandir</em> will only remove the subdirectories of the corresponding UID of the <em>owner</em> while the <em>live</em> root directory is not touched. If <em>live</em> was created on a RAM filesystem as suggested the deletion happens on the next reboot.</p>

<p><strong>Note</strong>: A running <em>scandir</em> can not be removed. It needs to be stopped first with <a href="66%E2%80%91scanctl.html">66-scanctl</a> quit or similar to be able to remove it. </p>

<h2 id="Boot%20specification">Boot specification</h2>

<p>The <strong>-b</strong> and <strong>-s</strong> option are called by <a href="66-boot.html">66-boot</a>. <strong>‑b</strong> will create .s6‑svscan control files (see <a href="https://skarnet.org/software/s6/s6-svscan.html">s6‑svscan</a> interface documentation) specifically for stage1 (PID1 process). This special <em>scandir</em> is controlled by the safe wrappers <code>halt</code>, <code>poweroff</code>, <code>reboot</code>, <code>shutdown</code> provided with <em>66</em> tools. The <a href="66%E2%80%91shutdownd.html">66-shutdownd</a> daemon which controls the shutdown request will be created automatically at the correct location. Further this specific task needs to read the skeleton file <code>init.conf</code> containing the <em>live</em> directory location which is the purpose of the <strong>‑s</strong> option.</p>

<p>The <em>live</em> directory for the boot process requires writable directories. In order to accommodate for read‑only root filesystems there needs to be a tmpfs mounted before <a href="https://skarnet.org/software/s6/s6-svscan.html">s6‑svscan</a> can be run. </p>
</body>
</html>
