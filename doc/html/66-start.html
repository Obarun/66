<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="date" content="2020-05-08" scheme="YYYY-MM-DD" />
<meta name="author" content="Eric Vidal &lt;eric@obarun.org&gt;" />
<title>The 66 Suite: 66-start</title>
</head>
<body>

<p><a href="index.html">66</a></p>

<p><a href="https://web.obarun.org">obarun.org</a></p>

<h1 id="66-start">66-start</h1>

<p>This command starts one ore more <em>services</em> defined in <em>tree</em>.</p>

<h2 id="Interface">Interface</h2>

<pre><code>    66-start [ -h ] [ -z ] [ -v verbosity ] [ -l live ] [ -t tree ] [ -T timeout ] [ -r | R ] service(s)
</code></pre>

<p>This tool expects to find an already enabled service inside the given <em>tree</em> and an already running <a href="66-scandir.html">scandir</a>. If the state of the <em>service</em> is already up, <em>66-start</em> does nothing except when passing the <strong>-r</strong> or <strong>-R</strong> option—see <a href="66-start.html#Reload%20transitions">reload transition</a>.</p>

<p>Multiple <em>services</em> can be started by seperating their names with a space.</p>

<h2 id="Exit%20codes">Exit codes</h2>

<ul>
<li><em>0</em> success</li>
<li><em>100</em> wrong usage</li>
<li><em>111</em> system call failed</li>
</ul>

<h2 id="Options">Options</h2>

<ul>
<li><p><strong>-h</strong> : prints this help.</p></li>
<li><p><strong>-z</strong> : use color.</p></li>
<li><p><strong>-v</strong> <em>verbosity</em> : increases/decreases the verbosity of the command.</p>

<ul>
<li><em>1</em> : only print error messages. This is the default.</li>
<li><em>2</em> : also print warning messages.</li>
<li><em>3</em> : also print tracing messages.</li>
<li><em>4</em> : also print debugging messages.</li>
</ul></li>
<li><p><strong>-l</strong> <em>live</em> : changes the supervision directory of <em>service</em> to <em>live</em>. By default this will be <code>%%livedir%%</code>. The default can also be changed at compile time by passing the <code>--livedir=live</code> option to <code>./configure</code>. An existing absolute path is expected and should be within a writable filesystem - likely a RAM filesystem—see <a href="66-scandir.html">66-scandir</a>.</p></li>
<li><p><strong>-t</strong> : handles the <em>selection</em> of the given <em>tree</em>. This option is mandatory except if a tree was marked as &#8216;current&#39;—see <a href="66-tree.html">66-tree</a>.</p></li>
<li><p><strong>-T</strong> <em>timeout</em> : specifies a timeout (in milliseconds) after which <em>66-start</em> will exit <code>111</code> with an error message if the <em>service</em> still hasn&#8217;t reached the up state. By default, the timeout is <code>1000</code>.</p></li>
<li><p><strong>-r</strong> : If the <em>service</em> is up, restart it, by sending it a signal to kill it and letting s6-supervise start it again. By default, the signal is a <code>SIGTERM</code>; this can be configured via the <code>@down-signal</code> field in the <a href="frontend.html">frontend service file</a>.</p></li>
</ul>

<h2 id="Dependencies%20handling">Dependencies handling</h2>

<p>In case of <code>bundle</code>, <code>atomic</code> or <code>module</code> services, any dependency chain will be resolved automatically. It is unnecessary to manually define chained sets of dependencies. If FooA has a declared dependency on FooB, FooB will be automatically considered and started first when starting FooA. This will run recursively until all dependencies are started.</p>

<h2 id="Classic%20service%20transitions">Classic service transitions</h2>

<ul>
<li><p><em>66-start</em> gathers the classic service(s) passed as argument in a list called <em>selection</em>.</p></li>
<li><p>The command first inspects this list to determine if any <em>service</em> in question was already written to it. If it was not then a new entry is added for each <em>service</em> passed as argument. It then copies the necessary files and directories of each newly written entry, creates a <em>down</em> file and the <em>event</em> fifo directory. After that it subscribes to the <em>services</em> fifo events, sends a reload signal to the scandir and waits for an event for every service in the <em>selection</em>. If a <em>timeout</em> occurs before receiving an event, the initialization fails.</p></li>
<li><p>If a reload was forced the command will use a <a href="66-start.html#Reload%20transitions">reload</a> transition instead.</p></li>
<li><p>The <em>selection</em> is then inspected again and searched for any logger that needs to be associated with the passed <em>service</em>. If any such instruction was found the corresponding logger <em>service</em> will be added to the selection as well.</p></li>
<li><p>Finally the command sends a <code>66-svctl -v verbosity -T timeout -l live -t tree -U selection</code> and waits for the resulting exit code.</p></li>
</ul>

<p>If any one of these processes fails then as a result <em>66-start</em> fails too and exits with code <code>111</code>.</p>

<h2 id="Bundle,%20atomic%20and%20module%20transitions">Bundle, atomic and module transitions</h2>

<ul>
<li><p><em>66-start</em> gathers the <code>bundle</code>, <code>atomic</code> and <code>module</code> service(s) passed as argument in a list called <em>selection</em>.</p></li>
<li><p>The command first inspects this list to determine if any service database in question of the given <em>tree</em> was already written to it. If it was not then a <code>66-init -v verbosity -l live -d tree</code> is automatically invoked and <em>66-start</em> will wait for the exit code of this automatic command. After that a reload signal is sent to the <a href="66-scandir.html">scandir</a> to inform it about the change.</p></li>
<li><p>If a reload was forced the command will use a <a href="66-start.html#Reload%20transitions">reload</a> transition instead.</p></li>
<li><p>Finally the command sends a <code>66-dbctl -v verbosity -T timeout -l live -t tree -u selection</code> and waits for the resulting exit code.</p></li>
</ul>

<p>If any one of these processes fails then as a result <em>66-start</em> fails too and exits with code <code>111</code>.</p>

<h2 id="Reload%20transitions">Reload transitions</h2>

<h3 id="Classic%20services">Classic services</h3>

<ul>
<li><p><em>66-start</em> gathers the classic service(s) passed as argument in a list called <em>selection</em>.</p></li>
<li><p>If the service(s) require(s) a logger it will also be added to the <em>selection</em>. The command then sends a <code>66-svctl -v verbosity -T timeout -l live -t tree -D selection</code> and waits for the corresponding exit code. It removes all files and directories of the <em>service</em>(s) from the scandir and continues with an init transition—see above.</p></li>
</ul>

<p>If this process fails then as a result <em>66-start</em> fails too and exits with code <code>111</code>.</p>

<h3 id="Bundle,%20atomic%20and%20module%20services">Bundle, atomic and module services</h3>

<ul>
<li><p><em>66-start</em> gathers the bundle and/or atomic service(s) passed as argument in a list called <em>selection</em>.</p></li>
<li><p>The command first makes a backup of the services database live within the given tree and switches to the backup with the help of <a href="https://skarnet.org/software/s6-rc/s6-rc-update.html">s6-rc-update</a>.</p></li>
<li><p>It then compiles the services database of the given <em>tree</em> from source with the help of <a href="https://skarnet.org/software/s6-rc/s6-rc-compile.html">s6-rc-compile</a>.</p></li>
<li><p>Next it switches from the services database <em>live</em> of the given <em>tree</em> to this newly compiled database after which it then sends a <code>66-dbctl -v verbosity -T timeout -l live -t tree -d selection</code>.</p></li>
<li><p>Finally it performs a <code>66-dbctl -v verbosity -T timeout -l live -t tree -u selection</code> and waits for the corresponding exit code.</p></li>
</ul>

<p>If any one of these processes fails then as a result 66-start fails too and exits with code <code>111</code>.</p>
</body>
</html>
